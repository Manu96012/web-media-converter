<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Media Converter</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>

<div id="loading-spinner" class="spinner-overlay" style="display:none;">
  <div class="spinner"></div>
</div>

<div class="page-wrapper">

  <div class="container">
	<div class="logo-container">
		<img src="{{ url_for('static', filename='logo.png') }}" alt="Web Media Converter Logo">
	</div>

    <div class="sections">

      <!-- VIDEO -->
      <div class="section">
        <h2>ðŸŽ¬ Video</h2>

        <!-- Video â†’ Video -->
        <form class="form" action="/video/to-video" method="post" enctype="multipart/form-data">
          <strong>Video â†’ Video</strong>
          <label class="file-drop">
            <span>Trascina il file qui o clicca per selezionarlo</span>
            <input type="file" name="file" accept="video/*" required>
          </label>

          <select name="format" class="format-select">
            <option value="mp4">MP4</option>
            <option value="mkv">MKV</option>
            <option value="webm">WEBM</option>
            <option value="avi">AVI</option>
            <option value="mov">MOV</option>
          </select>

          <button class="submit">Converti</button>
        </form>

        <hr>

        <!-- Video â†’ Audio -->
        <form class="form" action="/video/to-audio" method="post" enctype="multipart/form-data">
          <strong>Video â†’ Audio</strong>
          <label class="file-drop">
            <span>Trascina il file qui o clicca per selezionarlo</span>
            <input type="file" name="file" accept="video/*" required>
          </label>

          <select name="format" class="format-select">
            <option value="mp3">MP3</option>
            <option value="aac">AAC</option>
            <option value="m4a">M4A</option>
            <option value="wav">WAV</option>
            <option value="flac">FLAC</option>
            <option value="ogg">OGG</option>
            <option value="opus">OPUS</option>
            <option value="wma">WMA</option>
          </select>

          <button class="submit">Estrai audio</button>
        </form>
      </div>

      <!-- IMMAGINI -->
      <div class="section">
        <h2>ðŸ–¼ Immagini</h2>
        <form class="form" action="/image" method="post" enctype="multipart/form-data">
	<strong>Immagine â†’ Immagine</strong>
          <label class="file-drop">
            <span>Trascina il file qui o clicca per selezionarlo</span>
            <input type="file" name="file" accept="image/*" required>
          </label>

          <select name="format" class="format-select" data-type="image">
            <option value="jpg">JPG</option>
            <option value="jpeg">JPEG</option>
            <option value="png">PNG</option>
            <option value="webp">WEBP</option>
            <option value="bmp">BMP</option>
            <option value="tiff">TIFF</option>
            <option value="gif">GIF</option>
            <option value="heic">HEIC</option>
            <option value="avif">AVIF</option>
            <option value="ico">ICO</option>
          </select>

          <button class="submit">Converti</button>
        </form>

        <hr>

        <!-- Immagini â†’ Rimuovi Sfondo -->
        <form class="form" action="/image/remove-bg" method="post" enctype="multipart/form-data">
          <strong>Rimuovi Sfondo</strong>
          <label class="file-drop">
            <span>Trascina il file qui o clicca per selezionarlo</span>
            <input type="file" name="file" accept="image/*" required>
          </label>

          <select name="format" class="format-select-nobg" data-type="image">
            <option value="png">PNG</option>
            <option value="webp">WEBP</option>
            <option value="tiff">TIFF</option>
            <option value="gif">GIF</option>
            <option value="ico">ICO</option>
          </select>

          <button class="submit">Rimuovi Sfondo</button>
        </form>

      <hr>

      <!-- Arrotonda Angoli -->
        <form class="form" action="/image/round-corners" method="post" enctype="multipart/form-data">
          <strong>Arrotonda Angoli</strong>
          <label class="file-drop">
            <span>Trascina il file qui o clicca per selezionarlo</span>
            <input type="file" name="file" accept="image/*" required>
          </label>
          <select name="corner_percent" class="format-select">
            <option value="10">10%</option>
            <option value="20" selected>20%</option>
            <option value="30">30%</option>
            <option value="40">40%</option>
            <option value="50">50%</option>
          </select>
          <select name="format" class="format-select" data-type="image">
            <option value="png">PNG</option>
            <option value="webp">WEBP</option>
            <option value="gif">GIF</option>
            <option value="ico">ICO</option>
          </select>
          <button class="submit">Arrotonda</button>
        </form>
      </div>

      <!-- PDF -->
      <div class="section">
        <h2>ðŸ“„ PDF</h2>

        <!-- PDF â†’ Immagini -->
        <form class="form" action="/pdf/to-image" method="post" enctype="multipart/form-data">
          <strong>PDF â†’ Immagini</strong>
          <label class="file-drop">
            <span>Trascina il file qui o clicca per selezionarlo</span>
            <input type="file" name="file" accept=".pdf" required>
          </label>

          <select name="format" class="format-select">
            <option value="png">PNG</option>
            <option value="jpeg">JPEG</option>
          </select>

          <button class="submit">Converti</button>
        </form>

        <hr>

        <!-- Immagini â†’ PDF -->
        <form class="form" action="/pdf/to-pdf" method="post" enctype="multipart/form-data">
          <strong>Immagini â†’ PDF</strong>
          <label class="file-drop">
            <span>Trascina il file qui o clicca per selezionarlo</span>
            <input type="file" name="file" accept="image/*" required>
          </label>

          <button class="submit">Converti</button>
        </form>
      </div>

    </div>
  </div>
</div>
<footer>
    &copy; 2026 Manu9601 Â· LAN Media Tool Â· ffmpeg Â· ImageMagick Â· Poppler
  </footer>
<script>
/* Rimuove il formato di input dal menu */
function truncateFilename(name, maxLength) {
  if (name.length <= maxLength) return name;

  const extIndex = name.lastIndexOf(".");
  if (extIndex === -1) {
    return name.slice(0, maxLength - 1) + "â€¦";
  }

  const ext = name.slice(extIndex);
  const base = name.slice(0, maxLength - ext.length - 1);

  return base + "â€¦" + ext;
}

document.querySelectorAll('input[type="file"]').forEach(input => {
  input.addEventListener('change', () => {
    const file = input.files[0];
    if (!file) return;

    const ext = file.name.split('.').pop().toLowerCase();
    const form = input.closest('form');
    const select = form.querySelector('.format-select');

    if (select) {
      Array.from(select.options).forEach(opt => {
        if (opt.value.toLowerCase() === ext || opt.text.toLowerCase() === ext) {
          opt.style.display = 'none';
          if (opt.selected) select.selectedIndex = 0;
        } else {
          opt.style.display = 'block';
        }
      });
    }
  });
});

/* Drag & drop file */
document.querySelectorAll('.file-drop').forEach(drop => {
  const input = drop.querySelector('input[type="file"]');
  const span = drop.querySelector('span');

  function updateFileName() {
    if (input.files.length > 0) {
      const file = input.files[0];
      const accept = input.accept.split(',').map(a => a.trim());
      const ext = file.name.split('.').pop().toLowerCase();
      let valid = false;

      // controlla i tipi MIME generici video/*, image/* e le estensioni .pdf
      for (let a of accept) {
        if (a.endsWith('/*')) {
          const typePrefix = a.split('/')[0];
          if (file.type.startsWith(typePrefix + '/')) valid = true;
        } else if (a.startsWith('.')) {
          if (ext === a.slice(1).toLowerCase()) valid = true;
        } else {
          if (file.type === a) valid = true;
        }
      }

      if (!valid) {
        alert(`Tipo file non valido per questa sezione!\nHai selezionato: ${file.name}`);
        input.value = '';
        span.textContent = 'Trascina il file qui o clicca per selezionarlo';
        span.style.color = '#aaa';
        return false;
      }

      span.textContent = truncateFilename(file.name, 28);
      span.title = file.name;
      span.style.color = '#fff';
      return true;
    } else {
      span.textContent = 'Trascina il file qui o clicca per selezionarlo';
      span.style.color = '#aaa';
      return false;
    }
  }

  // dragover / dragleave per evidenziare il box
  drop.addEventListener('dragover', (e) => {
    e.preventDefault();
    drop.classList.add('dragover');
  });

  drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));

  drop.addEventListener('drop', (e) => {
    e.preventDefault();
    drop.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
      const dt = new DataTransfer();
      dt.items.add(e.dataTransfer.files[0]);
      input.files = dt.files;

      if (!updateFileName()) return; // file non valido
      input.dispatchEvent(new Event('change')); // aggiorna menu a tendina
    }
  });

  input.addEventListener('change', updateFileName);

  // intercetta submit del form per sicurezza
  const form = input.closest('form');
  form.addEventListener('submit', (e) => {
    if (!updateFileName()) {
      e.preventDefault(); // blocca submit se file non valido
    }
  });
});

document.querySelectorAll('.form').forEach(form => {
  form.addEventListener('submit', (e) => {
    e.preventDefault();

    // Mostra spinner
    const spinner = document.getElementById('loading-spinner');
    spinner.style.display = 'flex';

    const formData = new FormData(form);
    const action = form.getAttribute('action');

    const xhr = new XMLHttpRequest();
    xhr.open('POST', action, true);

    xhr.onreadystatechange = () => {
      if (xhr.readyState === 4) {
        spinner.style.display = 'none'; // nascondi spinner

        if (xhr.status === 200) {
          const blob = new Blob([xhr.response], {type: xhr.getResponseHeader('Content-Type')});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          const filename = xhr.getResponseHeader('Content-Disposition')?.split('filename=')[1] || 'file_output';
          a.download = filename.replace(/"/g, '');
          a.click();
          URL.revokeObjectURL(url);
        } else {
          alert('Errore nella conversione!');
        }
      }
    };

    xhr.responseType = 'blob';
    xhr.send(formData);
  });
});

</script>

</body>
</html>
